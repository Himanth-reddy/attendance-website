<!DOCTYPE html>
<html>
<head>
  <title>Secure Attendance</title>
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; background-color: #f8f9fa; }
    .container { max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #333; margin-bottom: 30px; }
    button { padding: 12px 25px; font-size: 18px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 5px; margin: 10px; transition: background-color 0.3s; }
    button:hover { background-color: #218838; }
    button:disabled { background-color: #777; cursor: not-allowed; }
    #msg { margin-top: 20px; padding: 15px; border-radius: 5px; font-weight: bold; font-size: 16px; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .loading { color: #007bff; }
    .date-info { margin-top: 10px; font-size: 14px; color: #666; }
    .student-info { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö Class Attendance</h1>
    <div class="date-info">
      Today: <span id="currentDate"></span>
    </div>
    <button id="signInButton" onclick="signIn()">üîê Sign in with Microsoft</button>
    <div id="msg"></div>
    <div id="studentInfo" class="student-info" style="display: none;"></div>
  </div>

  <script>
    // Your Google Apps Script URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwaviLvkbXze6hxzOPzk9m9pDl2piYaMYyjTm18uCr6fx_yKi6OyZzr_qn6tDwRlvT2/exec';

    const msalConfig = {
      auth: {
        clientId: "431b6b30-a967-431b-9852-e09635a28a40",
        authority: "https://login.microsoftonline.com/7359f896-71e2-4dae-b8a3-15cdf97f2f10",
        redirectUri: "https://quiet-alpaca-d3bd2c.netlify.app/"
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const signInButton = document.getElementById('signInButton');
    const msgDiv = document.getElementById('msg');
    const studentInfoDiv = document.getElementById('studentInfo');

    // Display current date
    document.getElementById('currentDate').innerText = new Date().toLocaleDateString();

    async function signIn() {
      signInButton.disabled = true;
      showMessage("üîÑ Please sign in with Microsoft...", "loading");
      hideStudentInfo();

      try {
        const loginResponse = await msalInstance.loginPopup({ scopes: ["user.read"] });
        const email = loginResponse.account.username;

        // Show student info
        showStudentInfo(email);

        if (!email.endsWith("@adityauniversity.in")) {
          showMessage("‚ùå Only @adityauniversity.in emails are allowed.", "error");
          signInButton.disabled = false;
          return;
        }

        const match = email.match(/^([0-9A-Z]{10})@adityauniversity\.in$/i);
        const studentId = match ? match[1].toUpperCase() : null;

        if (!studentId) {
          showMessage("‚ùå Invalid email format. Could not extract Student ID.", "error");
          signInButton.disabled = false;
          return;
        }
        
        showMessage("üìù Submitting attendance, please wait...", "loading");

        // Submit attendance with proper error handling
        await submitAttendance(email, studentId);

      } catch (err) {
        console.error('Error in signIn:', err);
        showMessage("‚ùå Sign-in failed. Please try again.", "error");
      } finally {
        signInButton.disabled = false;
      }
    }

    async function submitAttendance(email, studentId) {
      try {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('studentId', studentId);

        const response = await fetch(scriptURL, { 
          method: 'POST', 
          body: formData 
        });

        console.log('Response status:', response.status);

        const responseText = await response.text();
        console.log('Raw response:', responseText);

        // Check if the response is HTML (error page)
        if (responseText.trim().startsWith('<') || responseText.includes('<!DOCTYPE')) {
          console.error('Received HTML instead of JSON');
          throw new Error('Server returned an error page. Please check if the script is properly deployed.');
        }

        if (!responseText.trim()) {
          throw new Error('Server returned empty response');
        }

        // Parse JSON response
        let resultJson;
        try {
          resultJson = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response that failed to parse:', responseText);
          
          if (responseText.toLowerCase().includes('success')) {
            showMessage(`‚úÖ ${responseText}`, "success");
            return;
          } else if (responseText.toLowerCase().includes('error')) {
            throw new Error(`Server error: ${responseText}`);
          }
          
          throw new Error(`Invalid response from server: ${responseText.substring(0, 100)}...`);
        }

        // Handle the JSON response
        if (resultJson.success === true) {
          showMessage(`‚úÖ ${resultJson.message}`, "success");
          
          // Show additional info if available
          if (resultJson.data) {
            const info = `Submitted at: ${resultJson.data.time} on ${resultJson.data.date}`;
            setTimeout(() => {
              showMessage(`‚úÖ ${resultJson.message}<br><small>${info}</small>`, "success");
            }, 1000);
          }
          
        } else if (resultJson.success === false) {
          // Check if it's a duplicate submission
          if (resultJson.duplicate || resultJson.submittedToday) {
            showMessage(`‚ö†Ô∏è ${resultJson.message}`, "warning");
          } else {
            showMessage(`‚ùå ${resultJson.message}`, "error");
          }
        } else {
          // Legacy format handling
          const message = resultJson.message || "Unknown response";
          if (message.toLowerCase().includes('success')) {
            showMessage(`‚úÖ ${message}`, "success");
          } else {
            showMessage(`‚ùå ${message}`, "error");
          }
        }

      } catch (error) {
        console.error('Attendance submission error:', error);
        showMessage(`‚ùå Failed to submit attendance: ${error.message}`, "error");
        throw error;
      }
    }

    function showMessage(message, type) {
      msgDiv.innerHTML = message;
      msgDiv.className = type;
      msgDiv.style.display = 'block';
    }

    function showStudentInfo(email) {
      const match = email.match(/^([0-9A-Z]{10})@adityauniversity\.in$/i);
      const studentId = match ? match[1].toUpperCase() : 'Unknown';
      
      studentInfoDiv.innerHTML = `
        <strong>Student Info:</strong><br>
        Email: ${email}<br>
        Student ID: ${studentId}
      `;
      studentInfoDiv.style.display = 'block';
    }

    function hideStudentInfo() {
      studentInfoDiv.style.display = 'none';
    }
  </script>
</body>
</html>
