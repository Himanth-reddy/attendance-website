<!DOCTYPE html>
<html>
<head>
  <title>Secure Attendance</title>
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
    button { padding: 12px 25px; font-size: 18px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 5px; }
    button:disabled { background-color: #777; cursor: not-allowed; }
    #msg { margin-top: 20px; color: #007bff; font-weight: bold; font-size: 18px; }
    .error { color: #dc3545; }
    .success { color: #28a745; }
  </style>
</head>
<body>
  <h1>Class Attendance</h1>
  <button id="signInButton" onclick="signIn()">Sign in with Microsoft</button>
  <div id="msg"></div>

  <script>
    // ▼▼▼ THIS URL WILL BE REPLACED IN THE NEXT STEP ▼▼▼
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxwNFg6nzDgMXW59EhDv2YKc5WFiHCyArPoYUy1NGgwdXDSP1kkWIQjq03UhbYf5J-W/exec';
    // ▲▲▲ THIS URL WILL BE REPLACED IN THE NEXT STEP ▲▲▲

    const msalConfig = {
      auth: {
        clientId: "431b6b30-a967-431b-9852-e09635a28a40",
        authority: "https://login.microsoftonline.com/7359f896-71e2-4dae-b8a3-15cdf97f2f10",
        redirectUri: "https://quiet-alpaca-d3bd2c.netlify.app/"
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const signInButton = document.getElementById('signInButton');
    const msgDiv = document.getElementById('msg');

    async function signIn() {
      signInButton.disabled = true;
      msgDiv.innerText = "Please sign in with Microsoft...";
      msgDiv.className = "";

      try {
        const loginResponse = await msalInstance.loginPopup({ scopes: ["user.read"] });
        const email = loginResponse.account.username;

        if (!email.endsWith("@adityauniversity.in")) {
          msgDiv.innerText = "Only @adityauniversity.in emails are allowed.";
          msgDiv.className = "error";
          signInButton.disabled = false;
          return;
        }

        const match = email.match(/^([0-9A-Z]{10})@adityauniversity\.in$/i);
        const studentId = match ? match[1].toUpperCase() : null;

        if (!studentId) {
          msgDiv.innerText = "Invalid email format. Could not extract Student ID.";
          msgDiv.className = "error";
          signInButton.disabled = false;
          return;
        }
        
        msgDiv.innerText = "Submitting attendance, please wait...";
        msgDiv.className = "";

        // Submit attendance with proper error handling
        await submitAttendance(email, studentId);

      } catch (err) {
        console.error('Error in signIn:', err);
        msgDiv.innerText = "Sign-in or submission failed. Check console (F12) for details.";
        msgDiv.className = "error";
      } finally {
        signInButton.disabled = false;
      }
    }

    async function submitAttendance(email, studentId) {
  const WEB_APP_URL = 'YOUR_ACTUAL_WEB_APP_URL_HERE'; // Replace with your URL
  
  try {
    const formData = new FormData();
    formData.append('email', email);
    formData.append('studentId', studentId);

    const response = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: formData
    });

    // Check if response is OK
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Get response text first
    const responseText = await response.text();
    console.log('Raw response:', responseText);

    // Try to parse JSON
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (parseError) {
      console.error('JSON parse error:', parseError);
      console.error('Response text:', responseText);
      throw new Error('Invalid JSON response from server');
    }

    if (result.success) {
      console.log('Success:', result.message);
      return result;
    } else {
      console.error('Server error:', result.message);
      throw new Error(result.message);
    }

  } catch (error) {
    console.error('Request failed:', error);
    throw error;
  }
}

// Usage example
submitAttendance('student@example.com', '12345')
  .then(result => {
    console.log('Attendance recorded:', result);
  })
  .catch(error => {
    console.error('Failed to record attendance:', error.message);
  });
  </script>
</body>
</html>