<!DOCTYPE html>
<html>
<head>
  <title>Secure Attendance</title>
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
    button { padding: 12px 25px; font-size: 18px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 5px; }
    button:disabled { background-color: #777; cursor: not-allowed; }
    #msg { margin-top: 20px; color: #007bff; font-weight: bold; font-size: 18px; }
    .error { color: #dc3545; }
    .success { color: #28a745; }
  </style>
</head>
<body>
  <h1>Class Attendance</h1>
  <button id="signInButton" onclick="signIn()">Sign in with Microsoft</button>
  <div id="msg"></div>

  <script>
    // ▼▼▼ THIS URL WILL BE REPLACED IN THE NEXT STEP ▼▼▼
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxwNFg6nzDgMXW59EhDv2YKc5WFiHCyArPoYUy1NGgwdXDSP1kkWIQjq03UhbYf5J-W/exec';
    // ▲▲▲ THIS URL WILL BE REPLACED IN THE NEXT STEP ▲▲▲

    const msalConfig = {
      auth: {
        clientId: "431b6b30-a967-431b-9852-e09635a28a40",
        authority: "https://login.microsoftonline.com/7359f896-71e2-4dae-b8a3-15cdf97f2f10",
        redirectUri: "https://quiet-alpaca-d3bd2c.netlify.app/"
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const signInButton = document.getElementById('signInButton');
    const msgDiv = document.getElementById('msg');

    async function signIn() {
      signInButton.disabled = true;
      msgDiv.innerText = "Please sign in with Microsoft...";
      msgDiv.className = "";

      try {
        const loginResponse = await msalInstance.loginPopup({ scopes: ["user.read"] });
        const email = loginResponse.account.username;

        if (!email.endsWith("@adityauniversity.in")) {
          msgDiv.innerText = "Only @adityauniversity.in emails are allowed.";
          msgDiv.className = "error";
          signInButton.disabled = false;
          return;
        }

        const match = email.match(/^([0-9A-Z]{10})@adityauniversity\.in$/i);
        const studentId = match ? match[1].toUpperCase() : null;

        if (!studentId) {
          msgDiv.innerText = "Invalid email format. Could not extract Student ID.";
          msgDiv.className = "error";
          signInButton.disabled = false;
          return;
        }
        
        msgDiv.innerText = "Submitting attendance, please wait...";
        msgDiv.className = "";

        // Submit attendance with proper error handling
        await submitAttendance(email, studentId);

      } catch (err) {
        console.error('Error in signIn:', err);
        msgDiv.innerText = "Sign-in or submission failed. Check console (F12) for details.";
        msgDiv.className = "error";
      } finally {
        signInButton.disabled = false;
      }
    }

    async function submitAttendance(email, studentId) {
      try {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('studentId', studentId);

        const response = await fetch(scriptURL, { 
          method: 'POST', 
          body: formData 
        });

        // Log the response status
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        // Get the raw response text first
        const responseText = await response.text();
        console.log('Raw response:', responseText);

        // Check if the response is HTML (error page)
        if (responseText.trim().startsWith('<') || responseText.includes('<!DOCTYPE')) {
          console.error('Received HTML instead of JSON');
          throw new Error('Server returned an error page instead of JSON. Check if the web app URL is correct and the deployment is active.');
        }

        // Check if response is empty
        if (!responseText.trim()) {
          throw new Error('Server returned empty response');
        }

        // Try to parse JSON
        let resultJson;
        try {
          resultJson = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response that failed to parse:', responseText);
          
          // If it looks like a plain text error message
          if (responseText.toLowerCase().includes('error')) {
            throw new Error(`Server error: ${responseText}`);
          }
          
          throw new Error(`Invalid JSON response from server: ${responseText.substring(0, 100)}...`);
        }

        // Handle the response
        if (resultJson.success === true) {
          msgDiv.innerText = resultJson.message || "Attendance submitted successfully!";
          msgDiv.className = "success";
        } else if (resultJson.success === false) {
          msgDiv.innerText = resultJson.message || "Failed to submit attendance";
          msgDiv.className = "error";
        } else {
          // Legacy format - check message content
          const message = resultJson.message || "Unknown response";
          if (message.toLowerCase().includes('success')) {
            msgDiv.innerText = message;
            msgDiv.className = "success";
          } else {
            msgDiv.innerText = message;
            msgDiv.className = "error";
          }
        }

      } catch (error) {
        console.error('Attendance submission error:', error);
        msgDiv.innerText = `Failed to submit attendance: ${error.message}`;
        msgDiv.className = "error";
        throw error; // Re-throw to be caught by signIn()
      }
    }
  </script>
</body>
</html>